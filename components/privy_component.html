<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Privy Auth Component</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      margin: 0;
      padding: 10px;
      background: transparent;
    }
    button {
      background-color: #0084ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0073e6;
    }
    button:active {
      background-color: #0066cc;
    }
    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <button id="loginBtn">ðŸ”— Conectar Billetera</button>
  <div id="status"></div>

  <script>
    // ConfiguraciÃ³n de Privy
    const PRIVY_APP_ID = '{{PRIVY_APP_ID}}';
    
    // FunciÃ³n para enviar datos a Streamlit
    function sendToStreamlit(data) {
      window.parent.postMessage(
        {
          isStreamlitMessage: true,
          type: "streamlit:setComponentValue",
          data: data
        },
        "*"
      );
    }

    // FunciÃ³n para actualizar el estado
    function updateStatus(message) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
    }

    // Cargar Privy SDK dinÃ¡micamente
    function loadPrivySDK() {
      return new Promise((resolve, reject) => {
        // Crear script tag para cargar Privy
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@privy-io/react-auth@latest/dist/umd/index.js';
        script.async = true;
        script.onload = () => {
          // Esperar a que Privy estÃ© disponible en window
          let attempts = 0;
          const checkInterval = setInterval(() => {
            if (window.Privy) {
              clearInterval(checkInterval);
              resolve(window.Privy);
            } else if (attempts > 50) {
              clearInterval(checkInterval);
              reject(new Error('Privy SDK no se cargÃ³'));
            }
            attempts++;
          }, 100);
        };
        script.onerror = () => {
          reject(new Error('Error al cargar el script de Privy'));
        };
        document.head.appendChild(script);
      });
    }

    // FunciÃ³n principal de login
    async function handleLogin() {
      try {
        updateStatus('Abriendo Privy...');
        
        // Cargar Privy SDK
        const Privy = await loadPrivySDK();
        
        if (!Privy) {
          sendToStreamlit({ error: 'Privy SDK no se cargÃ³ correctamente' });
          updateStatus('Error: Privy no disponible');
          return;
        }

        updateStatus('Conectando billetera...');

        // Usar la API de Privy directamente
        // Privy proporciona un mÃ©todo para autenticar
        const response = await fetch(`https://auth.privy.io/api/v1/apps/${PRIVY_APP_ID}/auth`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            login_methods: ['wallet'],
            appearance: {
              theme: 'light',
              accentColor: '#0084ff'
            }
          })
        });

        if (!response.ok) {
          // Si la API directa no funciona, intentar con el modal de Privy
          updateStatus('Usando modal de Privy...');
          
          // Crear un iframe para Privy
          const iframeContainer = document.createElement('div');
          iframeContainer.id = 'privy-modal';
          iframeContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          `;
          
          const iframe = document.createElement('iframe');
          iframe.src = `https://auth.privy.io/login?app_id=${PRIVY_APP_ID}&redirect_uri=${encodeURIComponent(window.location.origin)}`;
          iframe.style.cssText = `
            width: 100%;
            max-width: 500px;
            height: 600px;
            border: none;
            border-radius: 8px;
          `;
          
          iframeContainer.appendChild(iframe);
          document.body.appendChild(iframeContainer);
          
          // Esperar respuesta del iframe
          window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'privy_auth_success') {
              const { token, wallet } = event.data;
              
              // Limpiar iframe
              iframeContainer.remove();
              
              // Enviar datos a Streamlit
              updateStatus('Enviando datos...');
              sendToStreamlit({
                token: token,
                wallet: wallet,
                userId: event.data.userId
              });
              
              updateStatus('âœ… AutenticaciÃ³n completada');
            }
          });
          
          return;
        }

        const data = await response.json();
        
        if (data.token && data.wallet) {
          updateStatus('Enviando datos...');
          sendToStreamlit({
            token: data.token,
            wallet: data.wallet,
            userId: data.userId
          });
          
          updateStatus('âœ… AutenticaciÃ³n completada');
        } else {
          sendToStreamlit({ error: 'No se recibieron datos de autenticaciÃ³n' });
          updateStatus('Error: Sin datos');
        }

      } catch (error) {
        console.error('Error en login:', error);
        updateStatus('Error: ' + error.message);
        sendToStreamlit({ error: error.message || 'Error desconocido' });
      }
    }

    // Asignar el evento al botÃ³n
    document.getElementById('loginBtn').addEventListener('click', handleLogin);

    // Informar a Streamlit que el componente estÃ¡ listo
    window.parent.postMessage(
      {
        isStreamlitMessage: true,
        type: "streamlit:setFrameHeight",
        data: 80
      },
      "*"
    );
  </script>
</body>
</html>
